version: 2.1

description: |
  AWS Assume Role with Job context

orbs:
  aws-cli: circleci/aws-cli@0.1.6

display:
  source_url: "https://www.github.com/willbengtson/aws-assume-role-orb"

commands:
  assume_role:
    description: Installs AWS CLI and performs a sts assume-role to the target role with some job context
    parameters:
      account_id:
        description: AWS account ID where the target role lives
        type: string
      role_name:
        description: Role name
        type: string
    steps:
      - aws-cli/install
      - run:
          name: "Assume IAM Role"
          command: |
            set -e

            assume_role_creds=$(aws sts assume-role --role-arn "arn:aws:iam::<< parameters.account_id >>:role/<< parameters.role_name >>" \
            --role-session-name "${CIRCLE_PR_REPONAME}-${CIRCLE_BUILD_NUM}")
            echo 'export AWS_ACCESS_KEY_ID=$(echo ${assume_role_creds} | jq -r ".Credentials.AccessKeyId")' >> $BASH_ENV
            echo 'export AWS_SECRET_ACCESS_KEY=$(echo ${assume_role_creds} | jq -r ".Credentials.SecretAccessKey")' >> $BASH_ENV
            echo 'export AWS_SESSION_TOKEN=$(echo ${assume_role_creds} | jq -r ".Credentials.SessionToken")' >> $BASH_ENV
            echo 'export AWS_SESSION_EXPIRATION=$(echo ${assume_role_creds} | jq -r ".Credentials.Expiration")' >> $BASH_ENV
